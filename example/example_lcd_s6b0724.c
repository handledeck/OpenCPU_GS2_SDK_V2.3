#ifdef __EXAMPLE_LCD_S6B0724__
/***************************************************************************************************
*   Example:
*       
*            LCD_S6B0724 Routine
*
*   Description:
*
*           This example gives an example for LCD_S6B0724 setting.
*           Through Uart port, input the special command, there will be given the response about LCD operation.
*           
*
*   Usage:
*
*           Precondition:
*
*                   Use "make LCD_S6B0724" to compile, and download bin image to module.
*  Through Uart port:
*          if input "InitLCD" LCD S6B0724 init and then show a quectel logo
*          (after 1 step)if input "Chinese=ÒÆ,y=3,x=0" there has a chinese  character "ÒÆ" appear
            if input "slide" screen slide up to down or down to up
            if input "CleanLCD" clear the screen
****************************************************************************************************/ 
#include "ql_appinit.h"
#include "ql_interface.h"
#include "ql_type.h"
#include "ql_trace.h"
#include "ql_audio.h"
#include "ql_timer.h"
#include "ql_stdlib.h"
#include "ql_pin.h"
#include "ql_bus.h"
#include "ql_error.h"
#include "ql_fcm.h"
#include "ql_filesystem.h"

#define DEBUG_BUFFER_SIZE   100
#define OUT_DEBUG(x,...)  \
    Ql_memset((void*)(x),0,DEBUG_BUFFER_SIZE);  \
    Ql_sprintf((char*)(x),__VA_ARGS__);   \
    Ql_SendToUart(ql_uart_port1,(u8*)(x),Ql_strlen((const char*)(x)));
#define S6B0724_MAX_X 128
#define S6B0724_MAX_Y 64
#define S6B0724_piexls_X 131
#define S6B0724_piexls_Y 65
#define Character_piexls 16*16
#define MAX_PAGE 8
void LCD_S6B0724_Page_Display(QL_BUS_HANDLE busLcd,u8 page, u8 xstart, u8 * data_p, u32 datalen);
void LCD_S6B0724_Display(QL_BUS_HANDLE busLcd);
typedef enum SlideTypeTag
{
    UP_TO_DOWN=0,
    DOWN_TO_UP,
}SlideType;
bool converter = 1;
QlEventBuffer flSignalBuffer;
QlTimer SlideTimer;
char buffer[100];
char debug_buffer[DEBUG_BUFFER_SIZE];
QL_BUS_HANDLE busLcd = (QL_BUS_HANDLE)-1;
u8 lcd_ram_buffer[S6B0724_MAX_X*S6B0724_MAX_Y/8] = 
{/*--  picture\logo128X64.bmp  --*/
/*--  128x64  --*/
//  quectel log
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xC0,0xC0,0xC0,0xC0,
0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,
0x00,0x00,0x00,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xC0,0xC0,0xC0,
0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xC0,0xC0,
0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,
0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x40,
0x40,0xC0,0x40,0x40,0x40,0x40,0xC0,0xC0,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xF8,0xFF,0xFF,0xFF,0x3F,0x07,0x03,0x03,
0x07,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x80,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,0x00,
0x00,0x00,0xFE,0xFF,0xFF,0x07,0x00,0x00,0xC0,0xF8,0xFF,0xFF,0xFF,0x7F,0x0F,0x07,
0x03,0x03,0x03,0x03,0x03,0x07,0x00,0x00,0x00,0xE0,0xFC,0xFF,0xFF,0xFF,0x1F,0x07,
0x03,0x03,0x03,0x03,0x03,0x07,0x03,0x00,0x00,0x00,0x03,0x03,0x03,0xE3,0xFF,0x7F,
0x7F,0xFF,0x3F,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x60,0x58,0x4B,0x4A,0x4A,0x0A,
0x02,0x02,0x02,0x02,0x02,0x02,0x03,0x03,0x00,0x00,0x00,0x0B,0x00,0x00,0x00,0x08,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,
0xE0,0xFF,0xFF,0x3F,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x00,0x00,0x00,
0x80,0xFE,0xFF,0x7F,0x03,0x00,0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x0F,0x0F,
0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x00,0xFE,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0xFD,
0xFF,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xED,0xA9,0xA9,0xA9,0xA9,0x09,0x09,
0x09,0x09,0x09,0x09,0x09,0x0D,0x01,0x00,0x00,0x00,0x09,0x00,0x00,0x01,0x01,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x1F,0x67,0x33,0x7B,0xFB,0xE4,0xCC,0x3C,0x3E,
0x1F,0x0F,0x03,0x00,0x00,0x00,0x00,0x1F,0x3F,0x3F,0x3F,0x3F,0x3E,0x3C,0x3C,0x3E,
0x1F,0x0F,0x07,0x00,0x00,0x00,0x00,0x07,0x1F,0x3F,0x3F,0x3F,0x3F,0x3C,0x3C,0x3E,
0x3C,0x3C,0x3C,0x1C,0x00,0x00,0x00,0x00,0x0F,0x3F,0x3F,0x3F,0x3F,0x3E,0x3C,0x3E,
0x3C,0x3C,0x3C,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x3F,0x3F,0x3F,0x3F,
0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x35,0x35,0x35,0x35,0x34,0x34,
0x34,0x34,0x34,0x34,0x34,0x04,0x00,0x00,0x00,0x01,0x01,0x20,0x21,0x21,0x01,0x20,
0x20,0x20,0x00,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x06,0x18,0x61,0x87,0x1F,0x7C,
0xF0,0xE0,0xC8,0xD0,0x90,0x90,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x01,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

void LcdWriteCommand(QL_BUS_HANDLE busLcd, u8 cmd)
{
    QlBusAccess access;
    access.opcode = QL_BUSACCESSOPCODE_LCD_CMDWRITE;
    Ql_busWrite(busLcd, &access, &cmd, 1); 
}
void LcdWriteData(QL_BUS_HANDLE busLcd, u8 * data_p, u32 datalen)
{
    QlBusAccess access;
    access.opcode = QL_BUSACCESSOPCODE_LCD_DATAWRITE;
    Ql_busWrite(busLcd, &access,data_p, datalen);
}
void LcdReset(QL_BUS_HANDLE busLcd)
{
    QlBusAccess access;
    access.opcode = QL_BUSACCESSOPCODE_LCD_CLEAR_RESET;
    Ql_busWrite(busLcd, &access, NULL, 0);
    Ql_Sleep(10);
    access.opcode = QL_BUSACCESSOPCODE_LCD_SET_RESET;
    Ql_busWrite(busLcd, &access, NULL, 0);   
}
void LcdSetDisplayAddress(QL_BUS_HANDLE busLcd,u8 page, u8 xstart)
{
    u8 command;
    //Y Set Page Address(0-8)
    command =0xB0 | (page & 0x0F);
    LcdWriteCommand(busLcd,command);
    
    //X Set Column Address (0-131)  LSB
    command =0x00 | (xstart & 0x0F);// X address LSB
    LcdWriteCommand(busLcd,command);
    //X Set Column Address (0-131)  MSB
    command =0x10 | ((xstart>>4) & 0x0F);// X address MSB
    LcdWriteCommand(busLcd,command);; 

}
void LCD_S6B0724_Clr(QL_BUS_HANDLE busLcd)
{
    QlBusAccess access;
    u8 command,i;
    u8 lcd_clean_buffer[S6B0724_piexls_X];
    for(i=0;i<8;i++)
    {
        LcdSetDisplayAddress(busLcd,i,0);   
        // Write Data
        Ql_memset(lcd_clean_buffer, 0, S6B0724_piexls_X);
        LcdWriteData(busLcd,lcd_clean_buffer,S6B0724_piexls_X);
   }
}
//static QL_BUS_HANDLE busLcd
void LCD_S6B0724_Init(QL_BUS_HANDLE busLcd)
{

    //hardware Reset pin Reset LCD
    LcdReset(busLcd);    
   // Reset cmd
    //LcdWriteCommand(busLcd,0xe2);
    
   // ADC Select
    LcdWriteCommand(busLcd,0xa0);
   // SHL Select
    LcdWriteCommand(busLcd,0xc8); // 1100 8000   SHL = 0 (COM0 ® COM63)
   // LCD Bias Select    
    LcdWriteCommand(busLcd,0xa3);
   // Voltage Follower ON
    LcdWriteCommand(busLcd,0x2f);
    Ql_Sleep(5);
   
   // Regulator Resistor Select
    //LcdWriteCommand(busLcd,0x20);
    //set the line address
    LcdWriteCommand(busLcd,0x60);//  COM0
      
    Ql_Sleep(10);
    // Display ON
    LcdWriteCommand(busLcd,0xaf); 
    //Display quectel logo
    LCD_S6B0724_Display(busLcd);

}
void LCD_S6B0724_Page_Display(QL_BUS_HANDLE busLcd,u8 page, u8 xstart, u8 * data_p, u32 datalen)
{
    LcdSetDisplayAddress(busLcd,page,xstart);
    // Write Data
    LcdWriteData(busLcd, data_p, datalen);
}
void LCD_S6B0724_Display(QL_BUS_HANDLE busLcd)
{
    s8 i;
    LCD_S6B0724_Clr(busLcd);
    for(i=0;i<8;i++)
    {
        LCD_S6B0724_Page_Display(busLcd,i,1,(lcd_ram_buffer+i*128),(S6B0724_piexls_X-3));
    }

}
void LCD_Disply_One_Chinese_character( QL_BUS_HANDLE busLcd, u8 startpage, u8 xstart,u8 *GBKcode)
{
    QlBusAccess access;
    u8 command;
    s32 iret;
    s32 fp;
    s32 addressoffset;
    u32 readedlen;
    u8 CharacterBuffer[Character_piexls/8]={0x00,};
    //Identify specified Chinese characters dot matrix character by the GB232 encoding from the font file
    addressoffset = ((GBKcode[0]-0xa1)*0x5e+(GBKcode[1]-0xa1))*32;
    fp = Ql_FileOpenEx("GB2312.fon", QL_FS_READ_ONLY);
    if(fp<0)
    {
        OUT_DEBUG(debug_buffer,"\r\nfile open failed !!fp=%d\r\n",fp);
        return;
    }
    Ql_FileSeek(fp, addressoffset,QL_FS_FILE_BEGIN);
    iret = Ql_FileRead(fp, CharacterBuffer, 32, &readedlen);
    OUT_DEBUG(debug_buffer,"\r\nQl_FileReadf p=%d, len=%d\r\n",iret,readedlen);
    Ql_FileClose(fp);
    
    // Write startpage Data
    LcdSetDisplayAddress(busLcd,startpage,xstart); 
    LcdWriteData(busLcd, CharacterBuffer, Character_piexls/8/2);
    
    // Write  the secondpage Data
    LcdSetDisplayAddress(busLcd,startpage+1,xstart);
    LcdWriteData(busLcd, CharacterBuffer+Character_piexls/8/2, Character_piexls/8/2);
    
}

void LCD_S6B0724_slide(QL_BUS_HANDLE busLcd,SlideType type)
{
    u8 command;
    static s8 offset =0;
   OUT_DEBUG(debug_buffer,"\r\n !!slide display!!\r\n");
   offset++;
   if(offset>=64)
   offset =0; 
   if(UP_TO_DOWN == type)
   {
        command =0x7f-offset;//  slide display from top to bottom
   }
   else if(DOWN_TO_UP== type)
   {
        command =0x40+offset;//  slide display from bottom to top
   }
   LcdWriteCommand(busLcd, command);
}

void ql_entry()
{
    bool  keepGoing = TRUE;
    s32 period = 10;
    char *pData, *p,*p1,*p2;
    QlBusAccess access;
    u8 command;
    u8 data;
    u8 ascll[3]; // used for Chinese character encoding of GBK
    u8 page;
    u8 xstart;
    s32 iret;
    u32 GPIOvalue1,GPIOvalue2;
    Ql_SetDebugMode(ADVANCE_MODE);
    Ql_OpenModemPort(ql_md_port1);
    OUT_DEBUG(debug_buffer,"\r\nLCD S6B0724 test !!\r\n");
    SlideTimer.timeoutPeriod =Ql_MillisecondToTicks(100);

    while(keepGoing)
    {
        p=NULL;
        p1=NULL;
        p2=NULL;
        Ql_GetEvent(&flSignalBuffer);
        {
            switch(flSignalBuffer.eventType)
            {
                case EVENT_UARTDATA:
                {
                    if (flSignalBuffer.eventData.uartdata_evt.len>0)
                    {
                       QlBusAccess access;

                        pData = (char*)flSignalBuffer.eventData.uartdata_evt.data;
                    p = Ql_strstr(pData,"Chinese=");
                    if (p)
                    {
                        p+=8;
                        ascll[0]=*p;
                        ascll[1]=*(p+1);
                        ascll[2]='\0';
                        p1 = Ql_strstr(pData,",y=");
                        p1+=3;
                        page = Ql_atoi(p1);
                        p2 = Ql_strstr(pData,",x=");
                        p2+=3;
                        xstart = Ql_atoi(p2);
                        OUT_DEBUG(debug_buffer,"\r\npage = %d x =%d !!\r\n",page,xstart);
                        LCD_Disply_One_Chinese_character(busLcd,page,xstart,ascll);
                        break;
                    } 

                    p = Ql_strstr(pData,"slide");
                    if (p)
                    {
                        SlideTimer.timeoutPeriod =Ql_MillisecondToTicks(50);
                        Ql_StartTimer(&SlideTimer);
                    }
                    p = Ql_strstr(pData,"command");
                    if (p)
                    {
                        QlBusAccess access;
                        u8 data[3] = {0xaf,0x22,0xaa};
                        s32 cnt = 1000;
                        access.opcode = QL_BUSACCESSOPCODE_LCD_CMDWRITE;
                        busLcd =  0x700bf1ac;
                        iret = Ql_busWrite(busLcd, &access, data, 1);
                        
                        OUT_DEBUG(debug_buffer,"\r\nWrite Data command =%d\r\n",iret);
                        break;
                    }  
                    p = Ql_strstr(pData,"data");
                    if (p)
                    {
                        QlBusAccess access;
                        u8 data[3] = {0x11,0x22,0xaa};
                        s32 cnt = 1000;
                        access.opcode = QL_BUSACCESSOPCODE_LCD_DATAWRITE;
                       
                        iret = Ql_busWrite(busLcd, &access, data, 3);
                        
                        
                        OUT_DEBUG(debug_buffer,"\r\nLcd Write Data, iret=%d,\r\n",iret); 
                        break;
                    } 
                    p = Ql_strstr(pData,"CleanLCD");
                    if(p)
                    {
                        LCD_S6B0724_Clr(busLcd);
                        break;
                    }
                    p = Ql_strstr(pData,"InitLCD");
                    if(p)
                    {
                        QlBusParameter busparameter;
                        busparameter.busconfigversion = QL_BUS_VERSION;
                        busparameter.busparameterunion.lcd_serial_param_ex.rd_timing = 
                            busparameter.busparameterunion.lcd_serial_param_ex.wr_timing = 0x1<<5| ((0x1 << 5) << 16);
                        busparameter.busparameterunion.lcd_serial_param_ex.bit_size = QL_SERIAL_LCD_BITSIZE_8;
                        busparameter.busparameterunion.lcd_serial_param_ex.pins[QL_LSCK] = QL_PINNAME_LSCK;
                        busparameter.busparameterunion.lcd_serial_param_ex.pins[QL_LSDA] = QL_PINNAME_LSDA;
                        busparameter.busparameterunion.lcd_serial_param_ex.pins[QL_LSA0] = QL_PINNAME_LSA0;
                        busparameter.busparameterunion.lcd_serial_param_ex.pins[QL_LSCS] = QL_PINNAME_LSCS;
                        busparameter.busparameterunion.lcd_serial_param_ex.pins[QL_LSRST] = QL_PINNAME_LSRST;
                        if(busLcd > 0)                                    
                        { 
                            OUT_DEBUG(debug_buffer,"\r\nAlready Subscribe LCD\r\n");
                            break;
                        }
                        busLcd = Ql_busSubscribe(QL_BUSTYPE_LCD, &busparameter);
                        if(busLcd < 0)                                    
                        {
                            OUT_DEBUG(debug_buffer,"\r\nSubscribe LCD Failed=%d\r\n",(char *)busLcd);
                            break;
                        }
                        OUT_DEBUG(debug_buffer, "\r\nSubscribe LCD succcess busLcd =%x\r\n", (char *)busLcd );
                        LCD_S6B0724_Init(busLcd);
                    }

                    }
                    break;
                }
                case EVENT_MODEMDATA:
                {

                    break;
                }
                case EVENT_TIMER:
                {
                    Ql_StartTimer(&SlideTimer);
                    LCD_S6B0724_slide(busLcd,UP_TO_DOWN);
                    break;
                }

                default:
                    break;
            }

        }

    }

}





#endif
